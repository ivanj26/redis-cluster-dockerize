version: '3.8'
volumes:
  redis_1_data: {}
  redis_2_data: {}
  redis_3_data: {}
  redis_4_data: {}
  redis_5_data: {}
  redis_6_data: {}
  redis_7_data: {}
  redis_8_data: {}
  redis_9_data: {}
services:
  # Here we have three Redis containers with Cluster mode enabled,
  # three of them will work as master nodes and each one of
  # will have a replica, so in case of failures, the replica becomes the master.
  # They are configured by the `cluster_initiator` container.
  redis_1:
    image: 'redis:alpine'
    container_name: redis_1
    hostname: redis
    build: ./docker/redis
    ports:
      - "6378:6379"
    volumes:
      - redis_1_data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    command: [ "redis-server", "/usr/local/etc/redis/redis.conf" ]
    networks:
      redis_cluster_net:
        ipv4_address: 173.18.0.2

  redis_2:
    image: 'redis:alpine'
    container_name: redis_2
    hostname: redis
    build: ./docker/redis
    ports:
      - "6377:6379"
    volumes:
      - redis_2_data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    command: [ "redis-server", "/usr/local/etc/redis/redis.conf" ]
    networks:
      redis_cluster_net:
        ipv4_address: 173.18.0.3

  redis_3:
    image: 'redis:alpine'
    container_name: redis_3
    hostname: redis
    build: ./docker/redis
    ports:
      - "6376:6379"
    volumes:
      - redis_3_data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    command: [ "redis-server", "/usr/local/etc/redis/redis.conf" ]
    networks:
      redis_cluster_net:
        ipv4_address: 173.18.0.4

  redis_4:
    image: 'redis:alpine'
    container_name: redis_4
    hostname: redis
    build: ./docker/redis
    ports:
      - "6375:6379"
    volumes:
      - redis_4_data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    command: [ "redis-server", "/usr/local/etc/redis/redis.conf" ]
    networks:
      redis_cluster_net:
        ipv4_address: 173.18.0.5

  redis_5:
    image: 'redis:alpine'
    container_name: redis_5
    hostname: redis
    build: ./docker/redis
    ports:
      - "6374:6379"
    volumes:
      - redis_5_data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    command: [ "redis-server", "/usr/local/etc/redis/redis.conf" ]
    networks:
      redis_cluster_net:
        ipv4_address: 173.18.0.6
  
  redis_6:
    image: 'redis:alpine'
    container_name: redis_6
    hostname: redis
    build: ./docker/redis
    ports:
      - "6373:6379"
    volumes:
      - redis_6_data:/data
      - ./redis_tx.conf:/usr/local/etc/redis/redis.conf
    command: [ "redis-server", "/usr/local/etc/redis/redis.conf" ]
    networks:
      redis_cluster_net:
        ipv4_address: 173.18.0.7

  redis_7:
    image: 'redis:alpine'
    container_name: redis_7
    hostname: redis
    build: ./docker/redis
    ports:
      - "6372:6379"
    volumes:
      - redis_7_data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    command: [ "redis-server", "/usr/local/etc/redis/redis.conf" ]
    networks:
      redis_cluster_net:
        ipv4_address: 173.18.0.8

  redis_8:
    image: 'redis:alpine'
    container_name: redis_8
    build: ./docker/redis
    hostname: redis
    ports:
      - "6371:6379"
    volumes:
      - redis_8_data:/data
      - ./redis_tx.conf:/usr/local/etc/redis/redis.conf
    command: [ "redis-server", "/usr/local/etc/redis/redis.conf" ]
    networks:
      redis_cluster_net:
        ipv4_address: 173.18.0.9

  redis_9:
    image: 'redis:alpine'
    container_name: redis_9
    hostname: redis
    build: ./docker/redis
    ports:
      - "6370:6379"
    volumes:
      - redis_9_data:/data
      - ./redis_tx.conf:/usr/local/etc/redis/redis.conf
    command: [ "redis-server", "/usr/local/etc/redis/redis.conf" ]
    networks:
      redis_cluster_net:
        ipv4_address: 173.18.0.10

  # Ephemeral container to create the Redis cluster connections.
  # Once the setup is done, this container shuts down
  # and the cluster can be used by the service app container
  cluster_initiator:
    container_name: cluster_initiator
    build: ./docker/cluster
    tty: true
    depends_on:
      - redis_1
      - redis_2
      - redis_3
      - redis_4
      - redis_5
      - redis_6
      - redis_7
      - redis_8
      - redis_9
    networks:
      redis_cluster_net:
        ipv4_address: 173.18.0.12

# Rename the default network so we can easily identify it
# Across all containers
networks:
  redis_cluster_net:
    external: true
    name: redis_cluster_net
  # redis_cluster_net:
    # driver: bridge
    # ipam:
    #   driver: default
    #   config:
    #     - subnet: 173.18.0.0/16